version: '3.8'

services:
  rancher:
    image: rancher/rancher:v2.10.1 
    privileged: true 
    
    # === CRITICAL FIX for Ubuntu (AppArmor) ===
    security_opt:
      - apparmor:unconfined
    # ==========================================
    
    deploy:
      replicas: 1
      placement:
        # Constrain to manager node, where external resources exist
        constraints:
          - node.role == manager
      restart_policy:
        condition: any 
        delay: 5s 
        max_attempts: 3
        window: 120s

    ports:
      - target: 80
        published: 8181
        protocol: tcp
        mode: ingress
      - target: 443
        published: 8443
        protocol: tcp
        mode: ingress
        
    volumes:
      - rancher-vol:/var/lib/rancher

    networks:
      - rancher-nw

volumes:
  rancher-vol:
    external: true
    
networks:
  rancher-nw:
    external: true
